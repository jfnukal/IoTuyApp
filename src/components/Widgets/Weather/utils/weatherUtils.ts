// src/components/Widgets/Weather/utils/weatherUtils.ts
import { WEATHER_CONDITIONS, type WeatherAnimation } from '../types';

export class WeatherUtils {
  
  // P≈ôevod teploty
  static convertTemperature(celsius: number, unit: 'celsius' | 'fahrenheit'): number {
    if (unit === 'fahrenheit') {
      return Math.round((celsius * 9/5) + 32);
    }
    return Math.round(celsius);
  }

  // P≈ôevod rychlosti vƒõtru
  static convertWindSpeed(kmh: number, unit: 'kmh' | 'mph'): number {
    if (unit === 'mph') {
      return Math.round(kmh * 0.621371);
    }
    return Math.round(kmh);
  }

  // Form√°tov√°n√≠ teploty s jednotkou
  static formatTemperature(celsius: number, unit: 'celsius' | 'fahrenheit'): string {
    const temp = this.convertTemperature(celsius, unit);
    const symbol = unit === 'celsius' ? '¬∞C' : '¬∞F';
    return `${temp}${symbol}`;
  }

  // Form√°tov√°n√≠ rychlosti vƒõtru s jednotkou
  static formatWindSpeed(kmh: number, unit: 'kmh' | 'mph'): string {
    const speed = this.convertWindSpeed(kmh, unit);
    const unitText = unit === 'kmh' ? 'km/h' : 'mph';
    return `${speed} ${unitText}`;
  }

  // Z√≠sk√°n√≠ weather condition podle k√≥du
  static getWeatherCondition(code: number) {
    return WEATHER_CONDITIONS[code as keyof typeof WEATHER_CONDITIONS] || {
      name: 'Nezn√°m√© poƒças√≠',
      emoji: 'üåà',
      gradient: ['#87CEEB', '#E0E0E0'],
      animation: 'clouds' as WeatherAnimation['type']
    };
  }

  // Z√≠sk√°n√≠ gradientu pro pozad√≠
  static getWeatherGradient(code: number, timeOfDay: 'day' | 'night' = 'day'): readonly string[] {
    const condition = this.getWeatherCondition(code);
    
    if (timeOfDay === 'night') {
      // Tmav≈°√≠ verze pro noc
      return condition.gradient.map(color => this.darkenColor(color, 0.4));
    }
    
    return condition.gradient;
  }

  // Ztmaven√≠ barvy (pro noƒçn√≠ re≈æim)
  static darkenColor(color: string, factor: number): string {
    // Jednoduch√° implementace - m≈Ø≈æeme roz≈°√≠≈ôit
    const rgb = this.hexToRgb(color);
    if (!rgb) return color;
    
    return `rgb(${Math.floor(rgb.r * (1 - factor))}, ${Math.floor(rgb.g * (1 - factor))}, ${Math.floor(rgb.b * (1 - factor))})`;
  }

  // P≈ôevod hex na RGB
  static hexToRgb(hex: string): { r: number; g: number; b: number } | null {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
      r: parseInt(result[1], 16),
      g: parseInt(result[2], 16),
      b: parseInt(result[3], 16)
    } : null;
  }

  // Zji≈°tƒõn√≠, zda je den nebo noc
  static getTimeOfDay(hour: number): 'day' | 'night' {
    return hour >= 6 && hour <= 18 ? 'day' : 'night';
  }

  // Form√°tov√°n√≠ ƒçasu
  static formatTime(time: string, format24h: boolean = true): string {
    const date = new Date(time);
    
    if (format24h) {
      return date.toLocaleTimeString('cs-CZ', { 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    } else {
      return date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
      });
    }
  }

  // Form√°tov√°n√≠ data
  static formatDate(date: string): string {
    const dateObj = new Date(date);
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);

    // Porovn√°n√≠ dat
    if (dateObj.toDateString() === today.toDateString()) {
      return 'Dnes';
    } else if (dateObj.toDateString() === tomorrow.toDateString()) {
      return 'Z√≠tra';
    } else {
      return dateObj.toLocaleDateString('cs-CZ', { 
        weekday: 'short', 
        day: 'numeric',
        month: 'short'
      });
    }
  }

  // Z√≠sk√°n√≠ relativn√≠ho ƒçasu ("p≈ôed 5 minutami")
  static getRelativeTime(timestamp: number): string {
    const now = Date.now();
    const diffMs = now - timestamp;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMins / 60);

    if (diffMins < 1) {
      return 'Pr√°vƒõ teƒè';
    } else if (diffMins < 60) {
      return `P≈ôed ${diffMins} min`;
    } else if (diffHours < 24) {
      return `P≈ôed ${diffHours} hod`;
    } else {
      const diffDays = Math.floor(diffHours / 24);
      return `P≈ôed ${diffDays} dny`;
    }
  }

  // Z√≠sk√°n√≠ UV indexu s popisem
  static getUVDescription(uvIndex: number): { level: string; color: string; description: string } {
    if (uvIndex <= 2) {
      return {
        level: 'N√≠zk√Ω',
        color: '#4CAF50',
        description: 'Minim√°ln√≠ riziko'
      };
    } else if (uvIndex <= 5) {
      return {
        level: 'St≈ôedn√≠',
        color: '#FF9800',
        description: 'Pou≈æ√≠vej opalovac√≠ kr√©m'
      };
    } else if (uvIndex <= 7) {
      return {
        level: 'Vysok√Ω',
        color: '#FF5722',
        description: 'Opatrnost na slunci'
      };
    } else if (uvIndex <= 10) {
      return {
        level: 'Velmi vysok√Ω',
        color: '#F44336',
        description: 'Vyh√Ωbej se slunci'
      };
    } else {
      return {
        level: 'Extr√©mn√≠',
        color: '#9C27B0',
        description: 'Nebezpeƒçn√©!'
      };
    }
  }

  // Z√≠sk√°n√≠ popisu vlhkosti
  static getHumidityDescription(humidity: number): string {
    if (humidity < 30) {
      return 'Velmi sucho';
    } else if (humidity < 50) {
      return 'Sucho';
    } else if (humidity < 70) {
      return 'P≈ô√≠jemnƒõ';
    } else if (humidity < 85) {
      return 'Vlhko';
    } else {
      return 'Velmi vlhko';
    }
  }

  // Z√≠sk√°n√≠ animace podle poƒças√≠
  static getWeatherAnimation(code: number, intensity: 'light' | 'medium' | 'heavy' = 'medium'): WeatherAnimation {
    const condition = this.getWeatherCondition(code);
    
    const animations: Record<WeatherAnimation['type'], WeatherAnimation> = {
      sun: {
        type: 'sun',
        intensity,
        particles: 20,
        speed: 0.5
      },
      clouds: {
        type: 'clouds',
        intensity,
        particles: 15,
        speed: 0.3
      },
      rain: {
        type: 'rain',
        intensity,
        particles: intensity === 'light' ? 50 : intensity === 'medium' ? 100 : 200,
        speed: intensity === 'light' ? 2 : intensity === 'medium' ? 4 : 6
      },
      snow: {
        type: 'snow',
        intensity,
        particles: intensity === 'light' ? 30 : intensity === 'medium' ? 60 : 100,
        speed: intensity === 'light' ? 1 : intensity === 'medium' ? 2 : 3
      },
      storm: {
        type: 'storm',
        intensity,
        particles: 150,
        speed: 8
      },
      fog: {
        type: 'fog',
        intensity,
        particles: 40,
        speed: 0.2
      }
    };

    return animations[condition.animation] || animations.clouds;
  }

  // Zji≈°tƒõn√≠, zda je poƒças√≠ vhodn√© pro aktivity
  static getActivityRecommendation(temperature: number, conditionCode: number, windSpeed: number): {
    outdoor: boolean;
    activity: string;
    reason: string;
  } {
        
    // Bou≈ôe nebo siln√Ω d√©≈°≈•
    if (conditionCode >= 1273 || conditionCode === 1186) {
      return {
        outdoor: false,
        activity: 'Z≈Østa≈à doma',
        reason: 'Nebezpeƒçn√© poƒças√≠'
      };
    }

    // Velmi horko nebo zima
    if (temperature > 35) {
      return {
        outdoor: false,
        activity: 'Z≈Østa≈à v chl√°dku',
        reason: 'P≈ô√≠li≈° horko'
      };
    }

    if (temperature < -10) {
      return {
        outdoor: false,
        activity: 'Zah≈ôej se uvnit≈ô',
        reason: 'Mrzne'
      };
    }

    // M√≠rn√Ω d√©≈°≈•
    if (conditionCode >= 1180 && conditionCode <= 1183) {
      return {
        outdoor: true,
        activity: 'Nezapome≈à de≈°tn√≠k',
        reason: 'Lehk√Ω d√©≈°≈•'
      };
    }

    // Snƒõ≈æen√≠
    if (conditionCode >= 1210 && conditionCode <= 1225) {
      return {
        outdoor: true,
        activity: 'Obl√≠kni se teplo',
        reason: 'Snƒõ≈æ√≠'
      };
    }

    // Siln√Ω v√≠tr
    if (windSpeed > 30) {
      return {
        outdoor: false,
        activity: 'Pozor na v√≠tr',
        reason: 'Vƒõtrno'
      };
    }

    // Ide√°ln√≠ poƒças√≠
    if (temperature >= 15 && temperature <= 25 && conditionCode <= 1003) {
      return {
        outdoor: true,
        activity: 'Perfektn√≠ na proch√°zku!',
        reason: 'Kr√°sn√© poƒças√≠'
      };
    }

    // Defaultn√≠ doporuƒçen√≠
    return {
      outdoor: true,
      activity: 'Bƒõ≈æ ven a u≈æij si to!',
      reason: 'Docela fajn poƒças√≠'
    };
  }

  // Odhad obleƒçen√≠ podle poƒças√≠
  static getClothingRecommendation(temperature: number, conditionCode: number): {
    items: string[];
    emoji: string;
  } {
    const items: string[] = [];
    let emoji = 'üëï';

    if (temperature < 0) {
      items.push('Zimn√≠ bunda', 'ƒåepice', 'Rukavice', '≈†√°la', 'Tepl√© boty');
      emoji = 'üß•';
    } else if (temperature < 10) {
      items.push('Bunda', 'Svetr', 'Dlouh√© kalhoty');
      emoji = 'üß•';
    } else if (temperature < 20) {
      items.push('Mikina', 'Dlouh√© kalhoty');
      emoji = 'üëî';
    } else if (temperature < 25) {
      items.push('Triƒçko', 'Lehk√° bunda');
      emoji = 'üëï';
    } else {
      items.push('Triƒçko', 'Kra≈•asy');
      emoji = 'üëï';
    }

    // P≈ôid√°n√≠ podle poƒças√≠
    if (conditionCode >= 1180) { // D√©≈°≈•
      items.push('De≈°tn√≠k', 'Nepromokav√° bunda');
    }

    if (conditionCode >= 1210) { // Sn√≠h
      items.push('Vodƒõodoln√© boty');
    }

    return { items, emoji };
  }
}

// P≈ôeklad poƒças√≠ do ƒçe≈°tiny
export const translateWeatherCondition = (englishCondition: string): string => {
  const translations: { [key: string]: string } = {
    // Sluneƒçno
    'Clear': 'Jasno',
    'Sunny': 'Sluneƒçno',
    'Fair': 'P≈ô√≠jemn√© poƒças√≠',
    
    // Oblaƒçno
    'Partly cloudy': 'Polojasno',
    'Partly Cloudy': 'Polojasno',
    'Mostly cloudy': 'P≈ôev√°≈ænƒõ oblaƒçno',
    'Mostly Cloudy': 'P≈ôev√°≈ænƒõ oblaƒçno',
    'Cloudy': 'Oblaƒçno',
    'Overcast': 'Zata≈æeno',
    
    // D√©≈°≈•
    'Light rain': 'Slab√Ω d√©≈°≈•',
    'Light Rain': 'Slab√Ω d√©≈°≈•',
    'Rain': 'D√©≈°≈•',
    'Heavy rain': 'Siln√Ω d√©≈°≈•',
    'Heavy Rain': 'Siln√Ω d√©≈°≈•',
    'Drizzle': 'Mrholen√≠',
    'Showers': 'P≈ôeh√°≈àky',
    'Light drizzle': 'Slab√© mrholen√≠',
    
    // Sn√≠h
    'Snow': 'Sn√≠h',
    'Light snow': 'Slab√© snƒõ≈æen√≠',
    'Heavy snow': 'Siln√© snƒõ≈æen√≠',
    'Sleet': 'D√©≈°≈• se snƒõhem',
    'Freezing rain': 'Mrznouc√≠ d√©≈°≈•',
    
    // Bou≈ôky
    'Thunderstorm': 'Bou≈ôka',
    'Thunder': 'Bou≈ôka',
    'Storm': 'Bou≈ôe',
    
    // Mlha
    'Fog': 'Mlha',
    'Mist': 'Opar',
    'Haze': 'Lehk√° mlha',
    
    // V√≠tr
    'Windy': 'Vƒõtrno',
    'Breezy': 'M√≠rn√Ω v√≠tr',
    
    // Ostatn√≠
    'Hot': 'Horko',
    'Cold': 'Zima',
    'Humid': 'Vlhko',
    'Dry': 'Sucho',
  };

  return translations[englishCondition] || englishCondition;
};